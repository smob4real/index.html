<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Battle Arena - Epic Tug of War</title>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@400;600;700;800&display=swap');
/* ===== MOBILE FIX ===== */
/* ===== MOBILE FIX ===== */
@media (max-width: 600px) {
  body{
    align-items: flex-start !important;
    justify-content: flex-start !important;
    padding: 10px !important;
  }

  .character-select-screen,
  .game-container{
    padding: 18px !important;
    border-radius: 18px !important;
  }

  .player-setup{
    flex-direction: column !important;
    gap: 18px !important;
  }

  .character-select-screen h2{
    font-size: 2em !important;
    letter-spacing: 1px !important;
  }

  .select-subtitle{
    font-size: 1.05em !important;
    margin-bottom: 18px !important;
  }

  .start-battle-btn{
    font-size: 1.2em !important;
    padding: 16px 20px !important;
    border-radius: 14px !important;
  }

  .character-option .emoji{
    font-size: 3em !important;
  }
}
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --red-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            --blue-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gold-gradient: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            --dark-gradient: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        /* PARTICLE BACKGROUND */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 15s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(50px); opacity: 0; }
        }

        /* CHARACTER SELECTION SCREEN */
        .character-select-screen {
            position: relative;
            z-index: 1;
            background: var(--dark-gradient);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 30px 90px rgba(0,0,0,0.6);
            max-width: 1100px;
            width: 100%;
            color: white;
            animation: slideIn 0.6s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .character-select-screen h2 {
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5em;
            font-weight: 900;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            text-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
            letter-spacing: 4px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5)); }
            to { filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.8)); }
        }

        .select-subtitle {
            text-align: center;
            color: #93c5fd;
            font-size: 1.4em;
            margin-bottom: 40px;
            font-weight: 600;
        }

        .player-setup {
            display: flex;
            gap: 50px;
            margin-bottom: 40px;
        }

        .player-select-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 30px;
            border: 3px solid;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .player-select-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .player-select-section.p1 {
            border-color: #ff6b6b;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.3);
        }

        .player-select-section.p2 {
            border-color: #4facfe;
            box-shadow: 0 0 30px rgba(79, 172, 254, 0.3);
        }

        .player-select-section h3 {
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 2em;
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .player-select-section.p1 h3 {
            color: #ff6b6b;
            text-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
        }

        .player-select-section.p2 h3 {
            color: #4facfe;
            text-shadow: 0 0 15px rgba(79, 172, 254, 0.5);
        }

        .name-input-wrapper {
            margin-bottom: 30px;
        }

        .name-input-wrapper label {
            display: block;
            margin-bottom: 10px;
            font-size: 1em;
            color: #cbd5e1;
            font-weight: 600;
        }

        .name-input-wrapper input {
            width: 100%;
            padding: 15px;
            font-size: 1.4em;
            font-weight: 700;
            text-align: center;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            text-transform: uppercase;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
        }

        .name-input-wrapper input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .name-input-wrapper input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            transform: scale(1.02);
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 25px;
        }

        .character-option {
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .character-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.2), transparent);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .character-option:hover::before {
            width: 300px;
            height: 300px;
        }

        .character-option:hover {
            transform: translateY(-8px) scale(1.05);
            border-color: #ffd700;
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.3);
        }

        .character-option.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            box-shadow: 0 0 40px rgba(16, 185, 129, 0.6);
            animation: selectedPulse 1.5s ease-in-out infinite;
        }

        @keyframes selectedPulse {
            0%, 100% { box-shadow: 0 0 40px rgba(16, 185, 129, 0.6); }
            50% { box-shadow: 0 0 60px rgba(16, 185, 129, 0.9); }
        }

        .character-option .emoji {
            font-size: 4em;
            display: block;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
            transition: transform 0.3s;
        }

        .character-option:hover .emoji {
            transform: scale(1.2) rotate(5deg);
        }

        .character-option .name {
            font-size: 1.1em;
            font-weight: 700;
            color: #e5e7eb;
            position: relative;
            z-index: 1;
            font-family: 'Orbitron', sans-serif;
        }

        .start-battle-btn {
            display: block;
            margin: 40px auto 0;
            background: var(--gold-gradient);
            color: #1a1a2e;
            font-size: 2.2em;
            padding: 25px 80px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 15px 50px rgba(255, 215, 0, 0.5);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .start-battle-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .start-battle-btn:hover::before {
            width: 400px;
            height: 400px;
        }

        .start-battle-btn:hover:not(:disabled) {
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.7);
        }

        .start-battle-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .start-battle-btn:disabled {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        .selection-status {
            text-align: center;
            margin-top: 20px;
            font-size: 1.2em;
            color: #fbbf24;
            min-height: 35px;
            font-weight: 600;
        }

        /* GAME SCREEN */
        .game-container {
            position: relative;
            z-index: 1;
            background: linear-gradient(to bottom, #ffffff 0%, #f8fafc 100%);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 30px 90px rgba(0,0,0,0.4);
            max-width: 1000px;
            width: 100%;
            animation: slideIn 0.6s ease-out;
        }

        h1 {
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            font-size: 3em;
            font-weight: 900;
            letter-spacing: 3px;
        }

        .level-display {
            text-align: center;
            font-size: 1.8em;
            color: #8b5cf6;
            margin-bottom: 20px;
            font-weight: 800;
            font-family: 'Orbitron', sans-serif;
        }

        .rope-container {
            position: relative;
            height: 180px;
            background: linear-gradient(to bottom, #e0e7ff 0%, #c7d2fe 50%, #ddd6fe 100%);
            border-radius: 20px;
            margin: 25px 0;
            overflow: visible;
            border: 4px solid #667eea;
            box-shadow: inset 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .rope {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 12px;
            background: repeating-linear-gradient(
                90deg,
                #8b5cf6 0px,
                #8b5cf6 25px,
                #a78bfa 25px,
                #a78bfa 50px
            );
            transform: translateY(-50%);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .character {
            position: absolute;
            top: 50%;
            font-size: 6em;
            transform: translateY(-50%);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            filter: drop-shadow(0 8px 15px rgba(0,0,0,0.4));
        }

        @keyframes pullLeft {
            0%, 100% { transform: translateY(-50%) rotate(-12deg) translateX(0) scale(1); }
            50% { transform: translateY(-50%) rotate(-12deg) translateX(-8px) scale(1.05); }
        }

        @keyframes pullRight {
            0%, 100% { transform: translateY(-50%) scaleX(-1) rotate(-12deg) translateX(0) scale(1); }
            50% { transform: translateY(-50%) scaleX(-1) rotate(-12deg) translateX(-8px) scale(1.05); }
        }

        .character.player1 {
            left: 5%;
            animation: pullLeft 0.7s ease-in-out infinite;
        }

        .character.player2 {
            right: 5%;
            animation: pullRight 0.7s ease-in-out infinite;
        }

        .player-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 15%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            transition: all 0.3s;
        }

        .player-zone.left {
            left: 0;
            background: linear-gradient(to right, rgba(239, 68, 68, 0.2), transparent);
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
        }

        .player-zone.right {
            right: 0;
            background: linear-gradient(to left, rgba(59, 130, 246, 0.2), transparent);
            border-top-right-radius: 16px;
            border-bottom-right-radius: 16px;
        }

        .score-board {
            display: flex;
            justify-content: space-between;
            margin: 25px 0;
            gap: 25px;
        }

        .player-info {
            flex: 1;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .player-info:hover {
            transform: translateY(-5px);
        }

        .player1-info {
            background: var(--red-gradient);
            color: white;
        }

        .player2-info {
            background: var(--blue-gradient);
            color: white;
        }

        .player-name {
            font-size: 1.8em;
            margin-bottom: 12px;
            font-weight: 800;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .score {
            font-size: 3.5em;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .game-area {
            display: flex;
            gap: 35px;
            margin: 35px 0;
        }

        .player-section {
            flex: 1;
            padding: 30px;
            border-radius: 20px;
            background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .player1-section {
            border: 5px solid #ff6b6b;
        }

        .player2-section {
            border: 5px solid #4facfe;
        }

        .word-display {
            font-size: 2.8em;
            text-align: center;
            margin: 25px 0;
            letter-spacing: 10px;
            font-weight: 900;
            color: #1f2937;
            min-height: 70px;
            font-family: 'Orbitron', sans-serif;
        }

        .missing-letter {
            display: inline-block;
            width: 55px;
            height: 65px;
            border-bottom: 5px solid #6b7280;
            margin: 0 3px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { border-color: #6b7280; }
            50% { border-color: #fbbf24; }
        }

        .input-area {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }

        input[type="text"].game-input {
            width: 90px;
            height: 90px;
            font-size: 3.5em;
            text-align: center;
            border: 4px solid #d1d5db;
            border-radius: 15px;
            text-transform: uppercase;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
        }

        input[type="text"].game-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.3);
            transform: scale(1.05);
        }

        button {
            padding: 18px 35px;
            font-size: 1.3em;
            font-weight: 800;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-family: 'Poppins', sans-serif;
        }

        .submit-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .submit-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5);
        }

        .submit-btn:active {
            transform: scale(0.95);
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .timer {
            text-align: center;
            font-size: 4em;
            font-weight: 900;
            color: #667eea;
            margin: 25px 0;
            font-family: 'Orbitron', sans-serif;
        }

        .timer.warning {
            color: #ef4444;
            animation: timerPulse 0.6s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* WINNER CELEBRATION SCREEN */
        .winner-celebration {
            display: none;
            text-align: center;
            padding: 60px 40px;
            background: var(--dark-gradient);
            border-radius: 30px;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
            animation: celebrationEntrance 0.8s ease-out;
        }

        @keyframes celebrationEntrance {
            from { 
                opacity: 0; 
                transform: scale(0.8) rotateY(20deg);
            }
            to { 
                opacity: 1; 
                transform: scale(1) rotateY(0);
            }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd700;
            animation: confettiFall 3s linear infinite;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(600px) rotate(360deg);
                opacity: 0;
            }
        }

        .winner-celebration h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 4.5em;
            font-weight: 900;
            margin-bottom: 30px;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: winnerGlow 1.5s ease-in-out infinite alternate;
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        @keyframes winnerGlow {
            from { 
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
                transform: scale(1);
            }
            to { 
                filter: drop-shadow(0 0 40px rgba(255, 215, 0, 1));
                transform: scale(1.02);
            }
        }

        .medal-container {
            margin: 40px 0;
            position: relative;
        }

        .medal {
            font-size: 15em;
            display: inline-block;
            animation: medalSpin 2s ease-in-out;
            filter: drop-shadow(0 20px 40px rgba(255, 215, 0, 0.6));
        }

        @keyframes medalSpin {
            0% {
                transform: rotateY(0deg) scale(0);
                opacity: 0;
            }
            50% {
                transform: rotateY(720deg) scale(1.2);
            }
            100% {
                transform: rotateY(720deg) scale(1);
                opacity: 1;
            }
        }

        .winner-character {
            font-size: 8em;
            margin: 20px 0;
            display: inline-block;
            animation: characterCelebrate 1s ease-in-out infinite;
        }

        @keyframes characterCelebrate {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        .winner-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5em;
            font-weight: 900;
            color: white;
            margin: 25px 0;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .winner-stats {
            font-size: 1.8em;
            color: #93c5fd;
            margin: 20px 0 30px;
            font-weight: 600;
        }

        .final-score-display {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin: 30px auto;
            max-width: 500px;
            backdrop-filter: blur(10px);
        }

        .final-score-display p {
            font-size: 1.6em;
            color: white;
            margin: 12px 0;
            font-weight: 600;
        }

        .level-complete {
            display: none;
            text-align: center;
            padding: 50px 40px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 25px;
            margin: 25px 0;
            box-shadow: 0 20px 60px rgba(16, 185, 129, 0.4);
        }

        .level-complete h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5em;
            color: white;
            margin-bottom: 25px;
            text-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-weight: 900;
        }

        .level-complete p {
            font-size: 1.8em;
            color: white;
            margin-bottom: 25px;
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        .feedback {
            text-align: center;
            font-size: 1.4em;
            margin: 15px 0;
            min-height: 40px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
        }

        .correct {
            color: #10b981;
            animation: feedbackPop 0.3s ease-out;
        }

        .incorrect {
            color: #ef4444;
            animation: shake 0.4s ease-out;
        }

        @keyframes feedbackPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .level-info {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .level-info p {
            margin: 8px 0;
            font-size: 1.3em;
            font-weight: 600;
        }

        .start-btn {
            display: block;
            margin: 25px auto;
            background: var(--gold-gradient);
            color: #1a1a2e;
            font-size: 1.8em;
            padding: 20px 60px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            box-shadow: 0 10px 35px rgba(255, 215, 0, 0.5);
        }

        .start-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 15px 45px rgba(255, 215, 0, 0.6);
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .player-setup {
                flex-direction: column;
                gap: 30px;
            }

            .character-select-screen h2 {
                font-size: 2.5em;
            }

            h1 {
                font-size: 2em;
            }

            .game-area {
                flex-direction: column;
            }

            .medal {
                font-size: 10em;
            }

            .winner-name {
                font-size: 2.5em;
            }
        }
    
        /* TOP BAR CONTROLS */
        .top-bar{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:15px;
            margin: -5px 0 15px;
            padding: 12px 14px;
            border-radius: 18px;
            background: linear-gradient(135deg, rgba(15,12,41,0.06), rgba(118,75,162,0.10));
            border: 2px solid rgba(102,126,234,0.25);
        }
        .top-bar-left, .top-bar-right{ display:flex; align-items:center; gap:10px; }
        .icon-btn-wrapper{
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .icon-btn{
            width:52px;
            height:52px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            border: 2px solid rgba(255,255,255,0.25);
            background: rgba(0,0,0,0.08);
            font-size: 1.6em;
            cursor:pointer;
            transition: transform .2s, box-shadow .2s, border-color .2s;
            padding: 0;
            line-height: 1;
        }
        .icon-btn:hover{ transform: translateY(-2px) scale(1.03); border-color: rgba(255,215,0,0.7); box-shadow: 0 10px 25px rgba(0,0,0,0.12); }
        .icon-btn:active{ transform: scale(0.97); }
        .icon-btn-label{
            font-size: 0.75em;
            font-weight: 700;
            color: #4facfe;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }

        .audio-controls{
            display:flex;
            flex-wrap:wrap;
            align-items:center;
            justify-content:flex-end;
            gap:10px 14px;
            padding: 6px 10px;
            border-radius: 14px;
            background: rgba(255,255,255,0.55);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.4);
        }
        .audio-controls .toggle{
            display:flex; align-items:center; gap:8px;
            font-weight:700; color:#111827;
            user-select:none;
        }
        .audio-controls input[type="checkbox"]{
            width:18px; height:18px;
            accent-color:#8b5cf6;
        }
        .audio-controls .select, .audio-controls .range{
            display:flex; align-items:center; gap:8px;
            font-weight:700; color:#111827;
        }
        .select-label, .range-label{ opacity:0.75; font-size:0.92em; }
        #sfx-pack{
            padding:8px 10px;
            border-radius: 12px;
            border:2px solid rgba(17,24,39,0.15);
            background:white;
            font-weight:800;
        }
        #master-volume{ width:130px; }

        /* MISSING LETTER FILL */
        .missing-letter{
            display:inline-grid;
            place-items:end center;
            width:55px;
            height:65px;
            border-bottom: 5px solid #6b7280;
            margin: 0 3px;
            animation: blink 1.5s infinite;
        }
        .missing-letter.filled{
            animation:none;
            border-bottom-color:#10b981;
            color:#111827;
            text-shadow: 0 3px 10px rgba(16,185,129,0.25);
        }
        .missing-letter .letter{
            font-size: 0.9em;
            transform: translateY(6px);
        }

        /* Reduce motion support */
        @media (prefers-reduced-motion: reduce){
            *{ animation-duration:0.001ms !important; animation-iteration-count:1 !important; transition-duration:0.001ms !important; }
        }

        @media (max-width: 768px){
            .top-bar{ flex-direction:column; align-items:stretch; }
            .top-bar-left, .top-bar-right{ justify-content:center; }
            .audio-controls{ justify-content:center; }
        }

        /* MODE BAR (VS CPU) */
        .mode-bar{
            display:flex;
            flex-wrap:wrap;
            align-items:center;
            justify-content:center;
            gap:14px 18px;
            margin: 0 auto 26px;
            padding: 14px 16px;
            border-radius: 18px;
            background: rgba(255,255,255,0.06);
            border: 2px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(10px);
        }
        .mode-toggle, .mode-select{
            display:flex;
            align-items:center;
            gap:10px;
            font-weight:800;
            color:#e5e7eb;
            user-select:none;
        }
        .mode-toggle input{ width:18px; height:18px; accent-color:#fbbf24; }
        .mode-select select{
            padding:8px 10px;
            border-radius: 12px;
            border:2px solid rgba(255,255,255,0.18);
            background: rgba(0,0,0,0.35);
            color:white;
            font-weight:900;
            font-family:'Orbitron',sans-serif;
        }
        .mode-label{ opacity:0.85; font-size:0.92em; }
        .mode-hint{
            flex-basis:100%;
            text-align:center;
            color:#93c5fd;
            font-weight:700;
            opacity:0.95;
        }

        /* ONLINE (INTERNET) MODE */
        .online-panel{
            display:flex;
            flex-wrap:wrap;
            align-items:center;
            justify-content:center;
            gap:10px 12px;
            padding: 10px 12px;
            border-radius: 16px;
            background: rgba(0,0,0,0.28);
            border: 2px solid rgba(255,255,255,0.14);
        }
        .online-panel.hidden{ display:none !important; }
        .online-panel input, .online-panel select{
            padding:10px 12px;
            border-radius: 12px;
            border:2px solid rgba(255,255,255,0.18);
            background: rgba(0,0,0,0.35);
            color:white;
            font-weight:900;
            font-family:'Orbitron',sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .online-panel input::placeholder{ color: rgba(255,255,255,0.45); }
        .online-panel .mini-btn{
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            cursor:pointer;
            font-weight: 900;
            letter-spacing: 1px;
            font-family:'Orbitron',sans-serif;
            text-transform: uppercase;
            background: var(--gold-gradient);
            color: #1a1a2e;
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.22);
        }
        .online-panel .mini-btn.ghost{
            background: rgba(255,255,255,0.10);
            color: white;
            border: 2px solid rgba(255,255,255,0.18);
            box-shadow:none;
        }
        .online-status{
            flex-basis:100%;
            text-align:center;
            color:#fbbf24;
            font-weight:800;
            min-height: 22px;
        }
        .player-select-section.cpu-locked{
            opacity:0.65;
            filter: grayscale(0.2);
        }
        .player-select-section.cpu-locked .character-option{
            cursor:not-allowed;
        }

        /* PAUSE OVERLAY */
        .pause-overlay{
            position: absolute;
            inset: 0;
            display:flex;
            align-items:center;
            justify-content:center;
            padding: 22px;
            background: rgba(15,12,41,0.68);
            backdrop-filter: blur(12px);
            border-radius: 30px;
            z-index: 50;
        }
        .pause-card{
            width:min(560px, 92vw);
            background: var(--dark-gradient);
            border: 3px solid rgba(255,255,255,0.14);
            border-radius: 22px;
            padding: 28px 26px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.55);
            text-align:center;
            color:white;
        }
        .pause-card h2{
            font-family:'Orbitron',sans-serif;
            font-size: 2.4em;
            letter-spacing: 2px;
            margin-bottom: 10px;
            background: var(--gold-gradient);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .pause-card p{
            color:#93c5fd;
            font-weight:700;
            margin: 10px 0 18px;
        }
        .pause-actions{
            display:flex;
            gap:12px;
            justify-content:center;
            flex-wrap:wrap;
            margin-top: 10px;
        }
        .pause-actions .start-btn{
            margin: 0;
            font-size: 1.2em;
            padding: 14px 26px;
        }
        .pause-actions .ghost-btn{
            background: rgba(255,255,255,0.10);
            color: white;
            border: 2px solid rgba(255,255,255,0.16);
            box-shadow:none;
        }

        /* CATEGORY SELECTION */
        .category-selection {
            margin: 35px 0;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .category-selection h3 {
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            color: #93c5fd;
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(79, 172, 254, 0.2), transparent);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .category-card:hover::before {
            width: 300px;
            height: 300px;
        }

        .category-card:hover {
            transform: scale(1.05) translateY(-5px);
            border-color: rgba(79, 172, 254, 0.5);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
        }

        .category-card.selected {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.15);
            box-shadow: 0 0 30px rgba(79, 172, 254, 0.5);
            transform: scale(1.05);
        }

        .category-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
            transition: transform 0.3s;
        }

        .category-card:hover .category-icon {
            transform: scale(1.2) rotate(5deg);
        }

        .category-card.selected .category-icon {
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .category-name {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.2em;
            color: #e2e8f0;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .category-description {
            font-size: 0.85em;
            color: #94a3b8;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

</style>
</head>
<body>
    <!-- Particle Background -->
    <div class="particles" id="particles"></div>

    <!-- CHARACTER SELECTION SCREEN -->
    <div class="character-select-screen" id="character-select">
        <h2>‚öîÔ∏è WORD BATTLE ARENA ‚öîÔ∏è</h2>
        <p class="select-subtitle">Choose Your Champion & Claim Victory!</p>


        <div class="mode-bar" aria-label="Game mode">
            <label class="mode-toggle">
                <input type="checkbox" id="cpu-toggle">
                <span>Play vs Computer</span>
            </label>
            <label class="mode-select">
                <span class="mode-label">CPU Difficulty</span>
                <select id="cpu-difficulty" aria-label="CPU difficulty">
                    <option value="easy">Easy</option>
                    <option value="normal" selected>Normal</option>
                    <option value="hard">Hard</option>
                </select>
            </label>
            
            <label class="mode-toggle">
                <input type="checkbox" id="online-toggle">
                <span>Play Online</span>
            </label>

            <div class="online-panel hidden" id="online-panel" aria-label="Online room">
                <input type="text" id="room-code" maxlength="10" placeholder="ROOM CODE">
                <button class="mini-btn" id="create-room-btn" type="button">CREATE</button>
                <button class="mini-btn ghost" id="join-room-btn" type="button">JOIN</button>
                <button class="mini-btn" id="matchmake-btn" type="button">FIND MATCH</button>
                <select id="role-select" aria-label="Online role">
                    <option value="host" selected>Host</option>
                    <option value="join">Join</option>
                </select>
                <div class="online-status" id="online-status">Online is off.</div>
            </div>
<div class="mode-hint" id="mode-hint">Tip: Turn on ‚ÄúPlay vs Computer‚Äù if Player 2 isn‚Äôt available.</div>
        </div>

        <!-- CATEGORY SELECTION -->
        <div class="category-selection">
            <h3>üìö SELECT WORD CATEGORY</h3>
            <div class="category-grid">
                <div class="category-card selected" onclick="selectCategory('animals', this)">
                    <span class="category-icon">ü¶Å</span>
                    <div class="category-name">ANIMALS</div>
                    <div class="category-description">Wildlife & Creatures</div>
                </div>
                <div class="category-card" onclick="selectCategory('science', this)">
                    <span class="category-icon">üî¨</span>
                    <div class="category-name">SCIENCE</div>
                    <div class="category-description">Chemistry & Physics</div>
                </div>
                <div class="category-card" onclick="selectCategory('sports', this)">
                    <span class="category-icon">‚öΩ</span>
                    <div class="category-name">SPORTS</div>
                    <div class="category-description">Games & Athletics</div>
                </div>
                <div class="category-card" onclick="selectCategory('countries', this)">
                    <span class="category-icon">üåç</span>
                    <div class="category-name">COUNTRIES</div>
                    <div class="category-description">Nations & Places</div>
                </div>
            </div>
        </div>

        <div class="player-setup">
            <!-- Player 1 Selection -->
            <div class="player-select-section p1">
                <h3>PLAYER 1</h3>
                <div class="name-input-wrapper">
                    <label>Champion Name (Max 8)</label>
                    <input type="text" id="p1-name-input" placeholder="WARRIOR" maxlength="8" value="HERO">
                </div>
                <div class="character-grid" id="p1-characters">
                    <div class="character-option" onclick="selectCharacter(1, 'ü•∑', 'Ninja', this)">
                        <span class="emoji">ü•∑</span>
                        <div class="name">Ninja</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(1, 'ü§ñ', 'Robot', this)">
                        <span class="emoji">ü§ñ</span>
                        <div class="name">Robot</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(1, 'ü¶∏', 'Hero', this)">
                        <span class="emoji">ü¶∏</span>
                        <div class="name">Hero</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(1, 'üßô', 'Wizard', this)">
                        <span class="emoji">üßô</span>
                        <div class="name">Wizard</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(1, 'ü¶π', 'Villain', this)">
                        <span class="emoji">ü¶π</span>
                        <div class="name">Villain</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(1, 'üëæ', 'Alien', this)">
                        <span class="emoji">üëæ</span>
                        <div class="name">Alien</div>
                    </div>
                </div>
            </div>

            <!-- Player 2 Selection -->
            <div class="player-select-section p2">
                <h3>PLAYER 2</h3>
                <div class="name-input-wrapper">
                    <label>Champion Name (Max 8)</label>
                    <input type="text" id="p2-name-input" placeholder="FIGHTER" maxlength="8" value="WARRIOR">
                </div>
                <div class="character-grid" id="p2-characters">
                    <div class="character-option" onclick="selectCharacter(2, 'ü•∑', 'Ninja', this)">
                        <span class="emoji">ü•∑</span>
                        <div class="name">Ninja</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(2, 'ü§ñ', 'Robot', this)">
                        <span class="emoji">ü§ñ</span>
                        <div class="name">Robot</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(2, 'ü¶∏', 'Hero', this)">
                        <span class="emoji">ü¶∏</span>
                        <div class="name">Hero</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(2, 'üßô', 'Wizard', this)">
                        <span class="emoji">üßô</span>
                        <div class="name">Wizard</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(2, 'ü¶π', 'Villain', this)">
                        <span class="emoji">ü¶π</span>
                        <div class="name">Villain</div>
                    </div>
                    <div class="character-option" onclick="selectCharacter(2, 'üëæ', 'Alien', this)">
                        <span class="emoji">üëæ</span>
                        <div class="name">Alien</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="selection-status" id="selection-status">Select your champions to begin the battle!</div>
        <button class="start-battle-btn" id="start-battle-btn" onclick="startBattle()" disabled>
            <span style="position: relative; z-index: 1;">START BATTLE</span>
        </button>
    </div>

    <!-- GAME SCREEN -->
    <div class="game-container hidden" id="game-container">
        <h1>‚öîÔ∏è WORD BATTLE ARENA ‚öîÔ∏è</h1>

        <div class="top-bar" aria-label="Game controls">
            <div class="top-bar-left">
                <div class="icon-btn-wrapper">
                    <button class="icon-btn" id="home-btn" title="Home" aria-label="Home">üè†</button>
                    <span class="icon-btn-label">Home</span>
                </div>
                <div class="icon-btn-wrapper">
                    <button class="icon-btn" id="reset-btn" title="Reset Battle" aria-label="Reset Battle">üîÑ</button>
                    <span class="icon-btn-label">Reset</span>
                </div>
                <div class="icon-btn-wrapper">
                    <button class="icon-btn" id="pause-btn" title="Pause" aria-label="Pause">‚è∏</button>
                    <span class="icon-btn-label">Pause</span>
                </div>
            </div>
            <div class="top-bar-right">
                <div class="audio-controls" aria-label="Audio controls">
                    <label class="toggle">
                        <input type="checkbox" id="music-toggle" checked>
                        <span>Music</span>
                    </label>
                    <label class="select">
                        <span class="select-label">Track</span>
                        <select id="music-track" aria-label="Music track">
                            <option value="neon" selected>Neon Loop</option>
                            <option value="chill">Chill</option>
                            <option value="arcadebeat">Arcade Beat</option>
                            <option value="epic">Epic</option>
                            <option value="retro">Retro</option>
                        </select>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" id="sfx-toggle" checked>
                        <span>SFX</span>
                    </label>
                    <label class="select">
                        <span class="select-label">Sounds</span>
                        <select id="sfx-pack" aria-label="Sound style">
                            <option value="arcade" selected>Arcade</option>
                            <option value="soft">Soft</option>
                            <option value="scifi">Sci‚ÄëFi</option>
                        </select>
                    </label>
                    <label class="range">
                        <span class="range-label">Vol</span>
                        <input type="range" id="master-volume" min="0" max="100" value="70" aria-label="Master volume">
                    </label>
                </div>
            </div>
        </div>


        <!-- PAUSE OVERLAY -->
        <div class="pause-overlay hidden" id="pause-overlay" role="dialog" aria-modal="true" aria-label="Paused">
            <div class="pause-card">
                <h2>‚è∏ PAUSED</h2>
                <p>Game is paused. Press <b>Esc</b> or tap <b>Resume</b> to continue.</p>
                <div class="pause-actions">
                    <button class="start-btn" id="resume-btn">RESUME</button>
                    <button class="start-btn ghost-btn" id="pause-home-btn">HOME</button>
                </div>
            </div>
        </div>

        <div class="level-display" id="level-display">LEVEL 1</div>

        <div class="rope-container">
            <div class="player-zone left">üèÅ</div>
            <div class="rope"></div>
            <div class="character player1" id="char1">ü•∑</div>
            <div class="character player2" id="char2">ü§ñ</div>
            <div class="player-zone right">üèÅ</div>
        </div>

        <div class="score-board">
            <div class="player-info player1-info">
                <div class="player-name" id="display-p1-name">HERO</div>
                <div class="score" id="player1-score">0</div>
            </div>
            <div class="player-info player2-info">
                <div class="player-name" id="display-p2-name">WARRIOR</div>
                <div class="score" id="player2-score">0</div>
            </div>
        </div>

        <div class="level-info hidden" id="level-info">
            <p id="level-description"></p>
            <p id="level-details"></p>
        </div>

        <div class="timer" id="timer">45</div>

        <div class="game-area hidden" id="game-area">
            <div class="player-section player1-section">
                <h3 style="text-align: center; color: #ff6b6b; margin-bottom: 20px; font-family: 'Orbitron', sans-serif; font-weight: 800;">PLAYER 1</h3>
                <div class="word-display" id="word1"></div>
                <div class="feedback" id="feedback1"></div>
                <div class="input-area">
                    <input type="text" class="game-input" id="input1" maxlength="1" oninput="this.value = this.value.toUpperCase()">
                    <button class="submit-btn" onclick="checkAnswer(1)">GO!</button>
                </div>
            </div>

            <div class="player-section player2-section">
                <h3 style="text-align: center; color: #4facfe; margin-bottom: 20px; font-family: 'Orbitron', sans-serif; font-weight: 800;">PLAYER 2</h3>
                <div class="word-display" id="word2"></div>
                <div class="feedback" id="feedback2"></div>
                <div class="input-area">
                    <input type="text" class="game-input" id="input2" maxlength="1" oninput="this.value = this.value.toUpperCase()">
                    <button class="submit-btn" onclick="checkAnswer(2)">GO!</button>
                </div>
            </div>
        </div>

        <!-- WINNER CELEBRATION -->
        <div class="winner-celebration" id="winner-celebration">
            <div id="confetti-container"></div>
            <h2 id="victory-title">üèÜ CHAMPION! üèÜ</h2>
            <div class="medal-container">
                <div class="medal">ü•á</div>
            </div>
            <div class="winner-character" id="winner-char">ü•∑</div>
            <div class="winner-name" id="winner-name">HERO</div>
            <div class="winner-stats" id="winner-subtitle">ULTIMATE WORD MASTER!</div>
            <div class="final-score-display">
                <p id="final-score-p1">HERO: 15 points</p>
                <p id="final-score-p2">WARRIOR: 12 points</p>
            </div>
            <button class="start-btn" onclick="resetGame()">NEW BATTLE</button>
        </div>

        <div class="level-complete" id="level-complete">
            <h2>üéâ ROUND COMPLETE! üéâ</h2>
            <p id="level-winner"></p>
            <p id="level-stats"></p>
            <button class="start-btn" onclick="nextLevel()">NEXT LEVEL</button>
        </div>
    </div>

    
    <script>
        /***********************
         * Word Battle Arena
         * Fixes + UX upgrades:
         * - No reliance on global `event`
         * - Home + Reset buttons
         * - Continuous background music (WebAudio) + toggle
         * - SFX packs + toggle
         * - Correct letters fill into missing slots
         * - Safer timer lifecycle
         ***********************/

        // --- Particle Background ---
        function createParticles() {
            const container = document.getElementById('particles');
            container.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                container.appendChild(particle);
            }
        }
        createParticles();

        // --- Confetti ---
        function createConfetti() {
            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            const colors = ['#ffd700', '#ff6b6b', '#4facfe', '#10b981', '#8b5cf6', '#f59e0b'];

            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(confetti);
            }
        }

        /***********************
         * AUDIO (WebAudio)
         * - Starts on first user gesture (required by browsers)
         * - Simple looping synth music
         * - 3 SFX packs
         ***********************/
        const AudioSys = (() => {
            let ctx = null;
            let master = null;
            let musicGain = null;
            let sfxGain = null;

            let started = false;
            let musicOn = true;
            let sfxOn = true;
            let masterVol = 0.9;
            let sfxPack = 'arcade';

            let musicTimer = null;
            let musicStep = 0;
            let musicTrack = 'neon';

            const tracks = {
                neon:      { name:'Neon Loop',   tempo: 160, waveA:'triangle', waveB:'sine',     scale:[261.63,293.66,329.63,392.00,440.00,523.25], prog:[0,3,4,3,2,1,0,2] },
                chill:     { name:'Chill',       tempo: 200, waveA:'sine',     waveB:'sine',     scale:[220.00,246.94,261.63,293.66,329.63,392.00], prog:[0,2,3,2,1,0,1,2] },
                arcadebeat:{ name:'Arcade Beat', tempo: 135, waveA:'square',   waveB:'triangle', scale:[261.63,311.13,349.23,392.00,466.16,523.25], prog:[0,1,3,1,4,3,1,2] },
                epic:      { name:'Epic',        tempo: 145, waveA:'sawtooth', waveB:'triangle', scale:[196.00,220.00,246.94,293.66,329.63,392.00], prog:[0,2,4,5,4,2,1,0] },
                retro:     { name:'Retro',       tempo: 120, waveA:'square',   waveB:'square',   scale:[261.63,293.66,311.13,349.23,392.00,466.16], prog:[0,2,3,2,4,3,2,1] },
            };

            function curTrack(){ return tracks[musicTrack] || tracks.neon; }

            function ensure() {
                if (ctx) return;
                ctx = new (window.AudioContext || window.webkitAudioContext)();
                master = ctx.createGain();
                musicGain = ctx.createGain();
                sfxGain = ctx.createGain();
                master.gain.value = masterVol;

                musicGain.gain.value = 0.9;
                sfxGain.gain.value = 0.25;

                musicGain.connect(master);
                sfxGain.connect(master);
                master.connect(ctx.destination);
            }

            function setMasterVolume(v01) {
                masterVol = Math.max(0, Math.min(1, v01));
                if (master) master.gain.value = masterVol;
            }

            function setMusic(on) {
                musicOn = !!on;
                if (musicGain) musicGain.gain.value = musicOn ? 0.9 : 0.0;
            }

            function setSfx(on) {
                sfxOn = !!on;
                if (sfxGain) sfxGain.gain.value = sfxOn ? 0.9 : 0.0;
            }

            function setPack(pack) {
                sfxPack = pack;
            }

            function note(freq, dur=0.12, type='sine', gain=0.18) {
                if (!ctx) return;
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = type;
                o.frequency.value = freq;
                g.gain.value = gain;

                o.connect(g);
                g.connect(musicGain);

                const now = ctx.currentTime;
                g.gain.setValueAtTime(gain, now);
                g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
                o.start(now);
                o.stop(now + dur + 0.02);
            }

            function sfx(pattern) {
                if (!ctx || !sfxOn) return;
                const now = ctx.currentTime;

                const o = ctx.createOscillator();
                const g = ctx.createGain();
                const f = ctx.createBiquadFilter();

                o.connect(f);
                f.connect(g);
                g.connect(sfxGain);

                // Pack tuning
                const pack = {
                    arcade: { type: 'square', filter: 'lowpass', q: 0.8 },
                    soft:   { type: 'sine',   filter: 'lowpass', q: 0.5 },
                    scifi:  { type: 'sawtooth', filter: 'bandpass', q: 2.0 },
                }[sfxPack] || { type: 'square', filter: 'lowpass', q: 0.8 };

                o.type = pack.type;
                f.type = pack.filter;
                f.Q.value = pack.q;

                // Envelope
                g.gain.setValueAtTime(0.0001, now);
                g.gain.exponentialRampToValueAtTime(0.9, now + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, now + (pattern.dur || 0.18));

                // Frequency curve
                o.frequency.setValueAtTime(pattern.f1, now);
                if (pattern.f2) o.frequency.exponentialRampToValueAtTime(pattern.f2, now + (pattern.dur || 0.18));

                // Filter curve for "scifi" vibe
                f.frequency.setValueAtTime(pattern.filter || 1200, now);
                f.frequency.exponentialRampToValueAtTime((pattern.filter2 || 400), now + (pattern.dur || 0.18));

                o.start(now);
                o.stop(now + (pattern.dur || 0.18) + 0.02);
            }

            function play(type) {
                if (!started) return;
                if (!ctx || !sfxOn) return;

                if (type === 'click')  return sfx({ f1: 600, f2: 420, dur: 0.08, filter: 1800, filter2: 800 });
                if (type === 'correct') return sfx({ f1: 520, f2: 900, dur: 0.18, filter: 2200, filter2: 900 });
                if (type === 'wrong')   return sfx({ f1: 280, f2: 190, dur: 0.22, filter: 900, filter2: 300 });
                if (type === 'win')     return sfx({ f1: 740, f2: 1200, dur: 0.28, filter: 2600, filter2: 1200 });
            }

            function startMusicLoop() {
                if (!ctx) return;
                stopMusicLoop();

                const t = curTrack();
                const stepMs = Math.max(90, Math.min(260, t.tempo)); // lower = faster

                musicStep = 0;
                musicTimer = window.setInterval(() => {
                    if (!musicOn) return;

                    const idx = t.prog[musicStep % t.prog.length];
                    const freq = t.scale[idx] || t.scale[0];

                    const type = (musicStep % 4 === 0) ? t.waveA : t.waveB;
                    note(freq, 0.12, type, 0.12);

                    if (musicStep % 8 === 0) note(freq * 2, 0.08, t.waveB, 0.06);
                    musicStep++;
                }, stepMs);
            }

            function stopMusicLoop() {
                if (musicTimer) {
                    clearInterval(musicTimer);
                    musicTimer = null;
                }
            }

            function setTrack(trackId){
                if (!tracks[trackId]) trackId = 'neon';
                musicTrack = trackId;
                if (started) startMusicLoop();
            }

            function start() {
                ensure();
                if (ctx.state === 'suspended') ctx.resume();
                if (!started) started = true;
                setMusic(musicOn);
                setSfx(sfxOn);
                setMasterVolume(masterVol);
                startMusicLoop();
            }

            function stopAll() {
                stopMusicLoop();
            }

            return {
                start,
                stopAll,
                play,
                setMusic,
                setSfx,
                setMasterVolume,
                setPack,
                setTrack,
                get state() { return { started, musicOn, sfxOn, masterVol, sfxPack, musicTrack }; }
            };
        })();

        // Start audio on first user gesture (required by browsers)
        function armAudioOnce() {
            AudioSys.start();
            window.removeEventListener('pointerdown', armAudioOnce);
            window.removeEventListener('keydown', armAudioOnce);
        }
        window.addEventListener('pointerdown', armAudioOnce, { once: true });
        window.addEventListener('keydown', armAudioOnce, { once: true });

        // --- Game State ---
        let player1Character = null;
        let player2Character = null;
        let player1Name = 'HERO';
        let player2Name = 'WARRIOR';

        let vsCPU = false;
        let cpuDifficulty = 'normal';
        let cpuTimer = null;
        let paused = false;

        // --- Online (internet) mode ---
        let onlineMode = false;
        let onlineRole = 'host';   // 'host' or 'join'
        let onlineConnected = false;
        let onlineRoom = '';
        let isHost = false;

        // WebRTC + signaling (requires a simple WebSocket relay server)
        // NOTE: Default is a placeholder. Replace SIGNALING_URL with your own secure wss:// endpoint.
        const SIGNALING_URL = "ws://localhost:8080"; // <- replace ________ with your Railway app subdomain
        let sigWS = null;
        let pc = null;
        let dc = null;
        let offerResendTimer = null;
        let clientId = Math.random().toString(36).slice(2);
        let remoteId = null;

        // Word pools by category
        const wordsByCategory = {
            animals: {
                1: ['CAT', 'DOG', 'FOX', 'OWL', 'BEE', 'ANT', 'BAT', 'RAT', 'PIG', 'COW'],
                2: ['LION', 'BEAR', 'WOLF', 'DEER', 'FROG', 'DUCK', 'FISH', 'BIRD', 'CRAB', 'SEAL'],
                3: ['TIGER', 'ZEBRA', 'WHALE', 'SHARK', 'EAGLE', 'SNAKE', 'HORSE', 'PANDA', 'KOALA', 'RHINO'],
                4: ['MONKEY', 'RABBIT', 'TURTLE', 'LIZARD', 'PARROT', 'FALCON', 'SALMON', 'SPIDER', 'JAGUAR', 'BEAVER'],
                5: ['DOLPHIN', 'PENGUIN', 'GIRAFFE', 'LEOPARD', 'OCTOPUS', 'GORILLA', 'PANTHER', 'CHEETAH', 'ELEPHANT', 'KANGAROO']
            },
            science: {
                1: ['GAS', 'DNA', 'ION', 'ORE', 'AIR', 'OIL', 'ICE', 'ATOM', 'BONE', 'CELL'],
                2: ['ACID', 'BASE', 'HEAT', 'WAVE', 'VOLT', 'MASS', 'LENS', 'COIL', 'FUEL', 'GENE'],
                3: ['LASER', 'ORBIT', 'METAL', 'LIGHT', 'SOUND', 'FORCE', 'MAGNET', 'CARBON', 'NEWTON', 'PLASMA'],
                4: ['ENERGY', 'PHOTON', 'PROTON', 'CARBON', 'OXYGEN', 'PLASMA', 'MOTION', 'GALAXY', 'NEUTRON', 'CALCIUM'],
                5: ['GRAVITY', 'QUANTUM', 'PHYSICS', 'BIOLOGY', 'VOLTAGE', 'MOLECULE', 'FRICTION', 'ELECTRIC', 'VELOCITY', 'PARTICLE']
            },
            sports: {
                1: ['RUN', 'SKI', 'BAT', 'NET', 'WIN', 'BOX', 'ROW', 'KICK', 'JUMP', 'RACE'],
                2: ['GOLF', 'SWIM', 'DIVE', 'PITCH', 'BOWL', 'BALL', 'GOAL', 'SHOT', 'TEAM', 'GAME'],
                3: ['TENNIS', 'SOCCER', 'HOCKEY', 'BOXING', 'RUGBY', 'MEDAL', 'TRACK', 'COURT', 'SPEED', 'SCORE'],
                4: ['ATHLETE', 'CRICKET', 'SURFING', 'CYCLING', 'STADIUM', 'JAVELIN', 'VICTORY', 'PLAYOFF', 'STRIKER', 'DEFENSE'],
                5: ['FOOTBALL', 'BASEBALL', 'MARATHON', 'SWIMMING', 'OLYMPICS', 'CHAMPION', 'TOURNAMENT', 'VOLLEYBALL', 'BASKETBALL', 'GYMNASTIC']
            },
            countries: {
                1: ['USA', 'UK', 'PERU', 'CUBA', 'CHAD', 'FIJI', 'IRAN', 'IRAQ', 'MALI', 'OMAN'],
                2: ['INDIA', 'CHINA', 'JAPAN', 'SPAIN', 'ITALY', 'EGYPT', 'CHILE', 'KENYA', 'LIBYA', 'NEPAL'],
                3: ['BRAZIL', 'FRANCE', 'RUSSIA', 'CANADA', 'MEXICO', 'GREECE', 'SWEDEN', 'POLAND', 'NORWAY', 'TURKEY'],
                4: ['GERMANY', 'BELGIUM', 'AUSTRIA', 'IRELAND', 'DENMARK', 'FINLAND', 'UKRAINE', 'ROMANIA', 'CROATIA', 'ICELAND'],
                5: ['AUSTRALIA', 'SINGAPORE', 'ARGENTINA', 'INDONESIA', 'VENEZUELA', 'PHILIPPINES', 'NETHERLANDS', 'SWITZERLAND', 'BANGLADESH', 'PORTUGAL']
            }
        };

        // Current selected category
        let selectedCategory = 'animals';

        // Get words for current category
        const wordsByLevel = {
            get 1() { return wordsByCategory[selectedCategory][1]; },
            get 2() { return wordsByCategory[selectedCategory][2]; },
            get 3() { return wordsByCategory[selectedCategory][3]; },
            get 4() { return wordsByCategory[selectedCategory][4]; },
            get 5() { return wordsByCategory[selectedCategory][5]; }
        };

        const levelConfig = {
            1: { time: 45, missingLetters: 1, description: 'BEGINNER', details: 'Short words ‚Ä¢ 1 missing letter ‚Ä¢ 45 seconds' },
            2: { time: 40, missingLetters: 1, description: 'EASY', details: 'Medium words ‚Ä¢ 1 missing letter ‚Ä¢ 40 seconds' },
            3: { time: 35, missingLetters: 1, description: 'MEDIUM', details: 'Longer words ‚Ä¢ 1 missing letter ‚Ä¢ 35 seconds' },
            4: { time: 30, missingLetters: 2, description: 'HARD', details: 'Longer words ‚Ä¢ 2 missing letters ‚Ä¢ 30 seconds' },
            5: { time: 25, missingLetters: 2, description: 'EXPERT', details: 'Complex words ‚Ä¢ 2 missing letters ‚Ä¢ 25 seconds' }
        };

        let currentLevel = 1;
        let player1Words = [];
        let player2Words = [];
        let player1CurrentWord = null;
        let player2CurrentWord = null;
        let player1Score = 0;
        let player2Score = 0;
        let player1TotalScore = 0;
        let player2TotalScore = 0;
        let timeLeft = 45;
        let timerInterval = null;
        let gameActive = false;
        let char1Position = 5;
        let char2Position = 95;

        // --- Helpers ---
        const $ = (id) => document.getElementById(id);

        function safeClearTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function renderPuzzle(wordObj) {
            const chars = wordObj.original.split('');
            const missing = new Set(wordObj.missingIndices);
            return chars.map((ch, idx) => {
                if (!missing.has(idx)) return ch;

                const foundIdx = wordObj.missingIndices.indexOf(idx);
                const found = wordObj.foundLetters[foundIdx] || '';
                const filled = found ? ' filled' : '';
                const letterSpan = found ? `<span class="letter">${found}</span>` : '';
                return `<span class="missing-letter${filled}" aria-label="missing">${letterSpan}</span>`;
            }).join('');
        }

        function setWordDisplay(player) {
            const wordObj = player === 1 ? player1CurrentWord : player2CurrentWord;
            const el = player === 1 ? $('word1') : $('word2');
            if (wordObj && el) el.innerHTML = renderPuzzle(wordObj);
        }

        function selectCharacter(player, emoji, name, el) {
            if (vsCPU && player === 2) { AudioSys.play('wrong'); return; }

            AudioSys.play('click');

            const grid = document.getElementById(`p${player}-characters`);
            const options = grid.querySelectorAll('.character-option');
            options.forEach(opt => opt.classList.remove('selected'));

            if (el) el.classList.add('selected');

            if (player === 1) player1Character = emoji;
            else player2Character = emoji;

            updateSelectionStatus();
        }

        function selectCategory(category, el) {
            AudioSys.play('click');

            // Remove selection from all category cards
            const allCards = document.querySelectorAll('.category-card');
            allCards.forEach(card => card.classList.remove('selected'));

            // Add selection to clicked card
            if (el) el.classList.add('selected');

            // Update selected category
            selectedCategory = category;

            console.log('Selected category:', category);
        }

        
function updateSelectionStatus() {
            const status = $('selection-status');
            const startBtn = $('start-battle-btn');

            // Online mode: host starts, guest waits.
            if (onlineMode) {
                // Online overrides CPU mode
                vsCPU = false;
                const cpuT = $('cpu-toggle'); if (cpuT) cpuT.checked = false;

                // Ensure role-based locking
                const p1Section = document.querySelector('.player-select-section.p1');
                const p2Section = document.querySelector('.player-select-section.p2');

                // Clear then apply locks
                if (p1Section) p1Section.classList.remove('cpu-locked');
                if (p2Section) p2Section.classList.remove('cpu-locked');
                if ($('p1-name-input')) $('p1-name-input').disabled = false;
                if ($('p2-name-input')) $('p2-name-input').disabled = false;

                if (onlineRole === 'host') {
                    if (p2Section) p2Section.classList.add('cpu-locked');
                    if ($('p2-name-input')) { $('p2-name-input').disabled = true; $('p2-name-input').value = (player2Name || 'GUEST'); }
                } else {
                    if (p1Section) p1Section.classList.add('cpu-locked');
                    if ($('p1-name-input')) { $('p1-name-input').disabled = true; $('p1-name-input').value = (player1Name || 'HOST'); }
                }

                if (!onlineConnected) {
                    status.textContent = 'Online: click CREATE (host) or JOIN (guest) to connect.';
                    startBtn.disabled = true;
                    return;
                }

                if (onlineRole === 'host') {
                    if (player1Character && player2Character) {
                        status.textContent = '‚úì Online ready! Press START BATTLE.';
                        startBtn.disabled = false;
                    } else if (player1Character) {
                        status.textContent = 'Waiting for guest to pick a champion...';
                        startBtn.disabled = true;
                    } else {
                        status.textContent = 'Pick your champion to host the online battle!';
                        startBtn.disabled = true;
                    }
                } else {
                    status.textContent = '‚úì Connected! Waiting for host to start...';
                    startBtn.disabled = true;
                }
                return;
            }


            // If CPU mode, lock Player 2 inputs and auto-set a CPU champion if needed.
            const p2Section = document.querySelector('.player-select-section.p2');
            const p2NameInput = $('p2-name-input');

            if (vsCPU) {
                if (p2Section) p2Section.classList.add('cpu-locked');
                if (p2NameInput) {
                    p2NameInput.value = 'CPU';
                    p2NameInput.disabled = true;
                }

                // Auto-pick CPU character if none selected yet (and mark visually)
                if (!player2Character) {
                    player2Character = 'ü§ñ';
                    const robot = document.querySelector('#p2-characters .character-option:nth-child(2)');
                    if (robot) {
                        document.querySelectorAll('#p2-characters .character-option').forEach(opt => opt.classList.remove('selected'));
                        robot.classList.add('selected');
                    }
                }

                if (player1Character) {
                    status.textContent = '‚úì Ready! You will battle the COMPUTER.';
                    startBtn.disabled = false;
                } else {
                    status.textContent = 'Select your champion to fight the COMPUTER!';
                    startBtn.disabled = true;
                }
                return;
            }

            // Non-CPU mode: restore Player 2 inputs
            if (p2Section) p2Section.classList.remove('cpu-locked');
            if (p2NameInput) p2NameInput.disabled = false;

            if (player1Character && player2Character) {
                status.textContent = '‚úì Both champions selected! Ready for epic battle!';
                startBtn.disabled = false;
            } else if (player1Character) {
                status.textContent = 'Champion 1 ready! Waiting for Champion 2...';
                startBtn.disabled = true;
            } else if (player2Character) {
                status.textContent = 'Champion 2 ready! Waiting for Champion 1...';
                startBtn.disabled = true;
            } else {
                status.textContent = 'Select your champions to begin the battle!';
                startBtn.disabled = true;
            }
        }

function startBattle() {
            AudioSys.play('click');

            // Online: host starts and syncs state; guest waits for host
            if (onlineMode) {
                if (onlineRole === 'host') {
                    if (startOnlineBattleAsHost()) return;
                }
                setOnlineStatus('Waiting for host to start...');
                return;
            }


            player1Name = $('p1-name-input').value.trim().toUpperCase() || 'HERO';
            player2Name = vsCPU ? 'COMPUTER' : ($('p2-name-input').value.trim().toUpperCase() || 'WARRIOR');

            if (vsCPU && !player2Character) player2Character = 'ü§ñ';

            $('display-p1-name').textContent = player1Name;
            $('display-p2-name').textContent = player2Name;

            $('char1').textContent = player1Character || 'ü•∑';
            $('char2').textContent = player2Character || 'ü§ñ';

            $('character-select').classList.add('hidden');
            $('game-container').classList.remove('hidden');

            player1TotalScore = 0;
            player2TotalScore = 0;

            startGame();
        }

        function generateWordPuzzle(word, numMissing) {
            const indices = [];
            const wordLength = word.length;

            while (indices.length < numMissing) {
                const idx = Math.floor(Math.random() * wordLength);
                if (!indices.includes(idx)) indices.push(idx);
            }
            indices.sort((a, b) => a - b);

            const missingLetters = indices.map(idx => word[idx]);

            return {
                original: word,
                missingLetters,
                missingIndices: indices,
                foundLetters: new Array(indices.length).fill('')
            };
        }

        function getNewWord() {
            const config = levelConfig[currentLevel];
            const used = new Set([
                ...player1Words.map(w => w.original),
                ...player2Words.map(w => w.original)
            ]);

            const availableWords = wordsByLevel[currentLevel].filter(w => !used.has(w));
            if (availableWords.length === 0) return null;

            const word = availableWords[Math.floor(Math.random() * availableWords.length)];
            return generateWordPuzzle(word, config.missingLetters);
        }

        function updateLevelDisplay() {
            const config = levelConfig[currentLevel];
            $('level-display').textContent = `LEVEL ${currentLevel} - ${config.description}`;
            $('level-description').textContent = config.description;
            $('level-details').textContent = config.details;
        }

        function startGame() {
            safeClearTimer();
            stopCPU();
            paused = false;
            const pov = $('pause-overlay'); 
            if (pov) pov.classList.add('hidden');
            $('timer').classList.remove('warning');

            $('game-area').classList.remove('hidden');
            $('winner-celebration').style.display = 'none';
            $('level-complete').style.display = 'none';
            $('level-info').classList.remove('hidden');

            const config = levelConfig[currentLevel];

            player1Words = [];
            player2Words = [];
            timeLeft = config.time;
            $('timer').textContent = timeLeft;

            char1Position = 5;
            char2Position = 95;
            gameActive = true;

            updateLevelDisplay();
            updateScores();
            updateCharacters();

            player1CurrentWord = getNewWord();
            player2CurrentWord = getNewWord();

            if (player1CurrentWord) {
                player1Words.push(player1CurrentWord);
                setWordDisplay(1);
            }
            if (player2CurrentWord) {
                player2Words.push(player2CurrentWord);
                setWordDisplay(2);
            }

            $('input1').value = '';
            $('input2').value = '';
            $('feedback1').textContent = '';
            $('feedback2').textContent = '';

            // Lock Player 2 controls if CPU mode
            const p2Input = $('input2');
            const p2Btn = document.querySelector('.player2-section .submit-btn');
            if (p2Input) p2Input.disabled = vsCPU;
            if (p2Btn) p2Btn.disabled = vsCPU;

            $('input1').disabled = false;
            $('input1').focus();

            paused = false;
            const overlay = $('pause-overlay');
            if (overlay) overlay.classList.add('hidden');

            stopCPU();
            if (vsCPU) scheduleCPU();

            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            if (!gameActive || paused) return;

            timeLeft = Math.max(0, timeLeft - 1);
            $('timer').textContent = timeLeft;

            if (timeLeft <= 10) $('timer').classList.add('warning');

            if (timeLeft <= 0) endLevel();
        }

        function checkAnswer(player, _fromCPU=false) {
            if (!gameActive || paused) return;
            if (vsCPU && player === 2 && !_fromCPU) { return; }

            // Online mode routing:
            // - Host validates both players, but only Player 1 is local
            // - Guest sends guesses to host for Player 2
            if (onlineMode) {
                if (!onlineConnected) { return; }

                if (!isHost) {
                    // Guest can only play as Player 2
                    if (player === 1) return;
                    if (player === 2 && !_fromCPU) {
                        const inputG = $('input2');
                        const fbG = $('feedback2');
                        const rawG = (inputG && inputG.value ? inputG.value : '').trim().toUpperCase();
                        if (!rawG) {
                            if (fbG){ fbG.textContent = 'Enter a letter!'; fbG.className = 'feedback incorrect'; }
                            AudioSys.play('wrong');
                            return;
                        }
                        sendDC({ t:'guess', letter: rawG[0] });
                        if (inputG) inputG.value = '';
                        if (fbG){ fbG.textContent = '‚Ä¶'; fbG.className = 'feedback'; }
                        return;
                    }
                } else {
                    // Host should not manually input for Player 2
                    if (player === 2 && !_fromCPU) return;
                }
            }


            const input = $(`input${player}`);
            const feedback = $(`feedback${player}`);
            const currentWord = player === 1 ? player1CurrentWord : player2CurrentWord;

            const raw = (input.value || '').trim().toUpperCase();
            if (!raw) {
                feedback.textContent = 'Enter a letter!';
                feedback.className = 'feedback incorrect';
                AudioSys.play('wrong');
                if (onlineMode && isHost) broadcastState();
                return;
            }

            // find next missing slot
            const nextSlot = currentWord.foundLetters.findIndex(v => !v);
            if (nextSlot === -1) return;

            const expected = currentWord.missingLetters[nextSlot];
            const letter = raw[0];

            if (letter === expected) {
                currentWord.foundLetters[nextSlot] = letter;

                // visually fill the missing space immediately
                setWordDisplay(player);

                AudioSys.play('correct');

                // word completed?
                const done = currentWord.foundLetters.every(v => v);
                if (done) {
                    feedback.textContent = '‚úì WORD COMPLETE!';
                    feedback.className = 'feedback correct';

                    if (player === 1) {
                        player1Score++;
                        player1TotalScore++;
                        char1Position += 8;
                        char2Position -= 2;
                    } else {
                        player2Score++;
                        player2TotalScore++;
                        char2Position -= 8;
                        char1Position += 2;
                    }

                    updateScores();
                    updateCharacters();

                    if (char1Position >= 85) return endLevel(1);
                    if (char2Position <= 15) return endLevel(2);

                    setTimeout(() => {
                        const newWord = getNewWord();
                        if (!newWord) return endLevel(); // no more words in this level

                        if (player === 1) {
                            player1CurrentWord = newWord;
                            player1Words.push(newWord);
                            setWordDisplay(1);
                        } else {
                            player2CurrentWord = newWord;
                            player2Words.push(newWord);
                            setWordDisplay(2);
                        }

                        input.value = '';
                        feedback.textContent = '';
                        input.focus();
                    }, 450);
                } else {
                    const remaining = currentWord.foundLetters.filter(v => !v).length;
                    feedback.textContent = `‚úì Correct! ${remaining} more to go`;
                    feedback.className = 'feedback correct';
                    input.value = '';
                    input.focus();
                    if (onlineMode && isHost) broadcastState();
                }

            } else {
                feedback.textContent = '‚úó Try again!';
                feedback.className = 'feedback incorrect';
                AudioSys.play('wrong');
                input.value = '';
                input.focus();
                if (onlineMode && isHost) broadcastState();
            }
        }

        function updateScores() {
            $('player1-score').textContent = player1Score;
            $('player2-score').textContent = player2Score;
        }

        function updateCharacters() {
            char1Position = Math.max(5, Math.min(95, char1Position));
            char2Position = Math.max(5, Math.min(95, char2Position));
            $('char1').style.left = char1Position + '%';
            $('char2').style.right = (100 - char2Position) + '%';
        }

        function endLevel(winner = null) {
            gameActive = false;
            safeClearTimer();
            stopCPU();
            paused = false;
            const pov = $('pause-overlay'); if (pov) pov.classList.add('hidden');

            $('game-area').classList.add('hidden');
            $('level-complete').style.display = 'block';

            if (onlineMode && isHost) broadcastState();

            if (winner === 1) {
                $('level-winner').textContent = `üèÜ ${player1Name} WINS THIS ROUND! üèÜ`;
                $('level-stats').textContent = `${player1Name}: ${player1Score} | ${player2Name}: ${player2Score}`;
                AudioSys.play('win');
                return;
            }
            if (winner === 2) {
                $('level-winner').textContent = `üèÜ ${player2Name} WINS THIS ROUND! üèÜ`;
                $('level-stats').textContent = `${player1Name}: ${player1Score} | ${player2Name}: ${player2Score}`;
                AudioSys.play('win');
                return;
            }

            // time-up / word exhaustion
            if (player1Score > player2Score) {
                $('level-winner').textContent = `üèÜ ${player1Name} WINS THIS ROUND! üèÜ`;
                $('level-stats').textContent = `${player1Name}: ${player1Score} | ${player2Name}: ${player2Score}`;
                AudioSys.play('win');
            } else if (player2Score > player1Score) {
                $('level-winner').textContent = `üèÜ ${player2Name} WINS THIS ROUND! üèÜ`;
                $('level-stats').textContent = `${player1Name}: ${player1Score} | ${player2Name}: ${player2Score}`;
                AudioSys.play('win');
            } else {
                $('level-winner').textContent = "ü§ù IT'S A TIE! ü§ù";
                $('level-stats').textContent = `Both champions: ${player1Score} points`;
            }
        }

        function nextLevel() {
            AudioSys.play('click');

            if (currentLevel < 5) {
                currentLevel++;
                player1Score = 0;
                player2Score = 0;
                $('level-complete').style.display = 'none';
                startGame();
                if (onlineMode && isHost) broadcastState();
            } else {
                showWinnerCelebration();
            }
        }

        function showWinnerCelebration() {
            $('level-complete').style.display = 'none';
            $('winner-celebration').style.display = 'block';

            createConfetti();
            AudioSys.play('win');

            if (player1TotalScore === player2TotalScore) {
                $('victory-title').textContent = 'ü§ù EPIC TIE! ü§ù';
                $('winner-char').textContent = `${player1Character} ${player2Character}`;
                $('winner-name').textContent = 'BOTH CHAMPIONS';
                $('winner-subtitle').textContent = 'EQUALLY MATCHED WARRIORS!';
                $('final-score-p1').textContent = `${player1Name}: ${player1TotalScore} points`;
                $('final-score-p2').textContent = `${player2Name}: ${player2TotalScore} points`;
                return;
            }

            const p1Wins = player1TotalScore > player2TotalScore;
            const winnerName = p1Wins ? player1Name : player2Name;
            const winnerChar = p1Wins ? player1Character : player2Character;

            $('victory-title').textContent = 'üèÜ CHAMPION! üèÜ';
            $('winner-char').textContent = winnerChar;
            $('winner-name').textContent = winnerName;
            $('winner-subtitle').textContent = 'ULTIMATE WORD MASTER!';
            $('final-score-p1').textContent = `${player1Name}: ${player1TotalScore} points`;
            $('final-score-p2').textContent = `${player2Name}: ${player2TotalScore} points`;
        }

        
        function setPaused(on){
            paused = !!on;
            const overlay = $('pause-overlay');
            
            if (paused) {
                // Show pause overlay
                if (overlay) overlay.classList.remove('hidden');
                stopCPU();
            } else {
                // Hide pause overlay
                if (overlay) overlay.classList.add('hidden');
                if (vsCPU && gameActive) scheduleCPU();
            }

            // Disable inputs/buttons while paused
            const in1 = $('input1'), in2 = $('input2');
            const btns = document.querySelectorAll('.submit-btn');
            if (in1) in1.disabled = paused;
            if (in2) in2.disabled = paused || vsCPU;
            btns.forEach(b => b.disabled = paused || (vsCPU && b.closest('.player2-section')));
        }

        function togglePause(){
            if ($('game-container').classList.contains('hidden')) return;
            if (!gameActive) return;
            
            AudioSys.play('click');
            setPaused(!paused);
        }

        // Reset battle (keep names/characters, restart at level 1)
        function resetBattle() {
            AudioSys.play('click');

            gameActive = false;
            safeClearTimer();

            currentLevel = 1;
            player1Score = 0;
            player2Score = 0;
            player1TotalScore = 0;
            player2TotalScore = 0;

            $('winner-celebration').style.display = 'none';
            $('level-complete').style.display = 'none';

            // Ensure characters on rope
            $('char1').textContent = player1Character || 'ü•∑';
            $('char2').textContent = player2Character || 'ü§ñ';

            startGame();
            if (onlineMode && isHost) broadcastState();
        }

        // Home: back to character select (full reset selection)
        function goHome() {
            AudioSys.play('click');

            gameActive = false;
            safeClearTimer();

            currentLevel = 1;
            player1Score = 0;
            player2Score = 0;
            player1TotalScore = 0;
            player2TotalScore = 0;
            player1Character = null;
            player2Character = null;

            document.querySelectorAll('.character-option').forEach(opt => opt.classList.remove('selected'));

            $('game-container').classList.add('hidden');
            $('character-select').classList.remove('hidden');

            $('winner-celebration').style.display = 'none';
            $('level-complete').style.display = 'none';
            $('level-info').classList.add('hidden');
            $('timer').classList.remove('warning');

            updateLevelDisplay();
            updateSelectionStatus();

            char1Position = 5;
            char2Position = 95;
            updateCharacters();
            updateScores();

            if (onlineMode && isHost && onlineConnected) {
                sendDC({ t:'home' });
            }
            if (onlineMode) cleanupOnline();
        }

        // Existing "NEW BATTLE" button should return to Home selection (as requested)
        function resetGame() {
            goHome();
        }

        
        function stopCPU(){
            if (cpuTimer) { clearTimeout(cpuTimer); cpuTimer = null; }
        }

        function cpuParams(){
            if (cpuDifficulty === 'easy')   return { min: 900, max: 1600, err: 0.28 };
            if (cpuDifficulty === 'hard')   return { min: 350, max: 800,  err: 0.08 };
            return { min: 600, max: 1200, err: 0.16 }; // normal
        }

        function scheduleCPU(){
            stopCPU();
            if (!vsCPU || !gameActive || paused) return;
            const p = cpuParams();
            const delay = Math.floor(p.min + Math.random() * (p.max - p.min));
            cpuTimer = setTimeout(cpuAttempt, delay);
        }

        function cpuAttempt(){
            if (!vsCPU || !gameActive || paused) return;

            const w = player2CurrentWord;
            if (!w) return scheduleCPU();

            const nextSlot = w.foundLetters.findIndex(v => !v);
            if (nextSlot === -1) return scheduleCPU();

            const expected = w.missingLetters[nextSlot];
            const p = cpuParams();
            const makeMistake = Math.random() < p.err;

            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let letter = expected;
            if (makeMistake){
                // pick a wrong letter
                let tries = 0;
                do {
                    letter = alphabet[Math.floor(Math.random() * alphabet.length)];
                    tries++;
                } while (letter === expected && tries < 10);
            }

            // Feed the letter and submit
            const input = $('input2');
            if (input) input.value = letter;
            checkAnswer(2, true);

            scheduleCPU();
        }

        // Keyboard: Enter submits based on focus
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { togglePause(); }
            if (e.key === 'Enter' && gameActive && !paused) {
                const active = document.activeElement;
                if (active && active.id === 'input1') checkAnswer(1);
                if (active && active.id === 'input2') checkAnswer(2, true);
            }
        });

        
        function saveAudioPrefs(_throttle=false){
            try{
                const data = {
                    music: $('music-toggle') ? $('music-toggle').checked : true,
                    sfx: $('sfx-toggle') ? $('sfx-toggle').checked : true,
                    pack: $('sfx-pack') ? $('sfx-pack').value : 'arcade',
                    vol: $('master-volume') ? parseInt($('master-volume').value, 10) : 70,
                    track: $('music-track') ? $('music-track').value : 'neon'
                };
                if (_throttle){
                    // basic throttle
                    window.__audioSaveT && clearTimeout(window.__audioSaveT);
                    window.__audioSaveT = setTimeout(() => localStorage.setItem('wba_audio', JSON.stringify(data)), 120);
                } else {
                    localStorage.setItem('wba_audio', JSON.stringify(data));
                }
            }catch(_){}
        }

        function loadAudioPrefs(){
            try{
                const raw = localStorage.getItem('wba_audio');
                if (!raw) return;
                const data = JSON.parse(raw);

                if ($('music-toggle') && typeof data.music === 'boolean') $('music-toggle').checked = data.music;
                if ($('sfx-toggle') && typeof data.sfx === 'boolean') $('sfx-toggle').checked = data.sfx;
                if ($('sfx-pack') && data.pack) $('sfx-pack').value = data.pack;
                if ($('master-volume') && typeof data.vol === 'number') $('master-volume').value = data.vol;
                if ($('music-track') && data.track) $('music-track').value = data.track;

                AudioSys.setMusic($('music-toggle') ? $('music-toggle').checked : true);
                AudioSys.setSfx($('sfx-toggle') ? $('sfx-toggle').checked : true);
                AudioSys.setPack($('sfx-pack') ? $('sfx-pack').value : 'arcade');
                AudioSys.setMasterVolume(($('master-volume') ? parseInt($('master-volume').value, 10) : 70) / 100);
                AudioSys.setTrack($('music-track') ? $('music-track').value : 'neon');
            }catch(_){}
        }

        // UI wiring for new buttons + audio controls
        /***********************
         * ONLINE MULTIPLAYER (INTERNET)
         * - WebRTC DataChannel for gameplay messages
         * - Requires a tiny WebSocket relay (signaling) server
         * - Host is authoritative for game state
         ***********************/
        function setOnlineStatus(msg){
            const el = $('online-status');
            if (el) el.textContent = msg;
        }

        function genRoomCode(){
            const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let s = '';
            for (let i=0;i<6;i++) s += alphabet[Math.floor(Math.random()*alphabet.length)];
            return s;
        }

        function cleanupOnline(){
            try{ if (dc) dc.close(); }catch(_){}
            try{ if (pc) pc.close(); }catch(_){}
            try{ if (sigWS) sigWS.close(); }catch(_){}
            try{ if (offerResendTimer) { clearInterval(offerResendTimer); offerResendTimer = null; } }catch(_){ }
            dc = null; pc = null; sigWS = null;
            onlineConnected = false;
            remoteId = null;
            setOnlineStatus('Not connected.');
            updateSelectionStatus();
        }

        function sendSig(obj){
            try{
                if (!sigWS || sigWS.readyState !== 1) return;
                sigWS.send(JSON.stringify(obj));
            }catch(_){}
        }

        function sendDC(obj){
            try{
                if (!dc || dc.readyState !== 'open') return;
                dc.send(JSON.stringify(obj));
            }catch(_){}
        }

        function bindDataChannel(channel){
            dc = channel;
            dc.onopen = () => {
                onlineConnected = true;
                setOnlineStatus(isHost ? 'Connected! Waiting for guest ready...' : 'Connected! Syncing with host...');
                // Send lobby info
                const payload = {
                    t: 'lobby',
                    name: (isHost ? $('p1-name-input')?.value : $('p2-name-input')?.value || '').trim().toUpperCase(),
                    char: (isHost ? player1Character : player2Character)
                };
                sendDC(payload);
                updateSelectionStatus();
            };
            dc.onclose = () => cleanupOnline();
            dc.onmessage = (ev) => {
                let msg = null;
                try{ msg = JSON.parse(ev.data); }catch(_){ return; }
                handleOnlineMessage(msg);
            };
        }

        function handleOnlineMessage(msg){
            if (!msg || !msg.t) return;

            // Lobby sync
            if (msg.t === 'lobby'){
                if (isHost){
                    // guest info becomes Player 2
                    player2Name = (msg.name || 'GUEST').slice(0,8) || 'GUEST';
                    player2Character = msg.char || player2Character || 'ü§ñ';
                    if ($('p2-name-input')){
                        $('p2-name-input').value = player2Name;
                    }
                    // Visual select for guest character (best-effort)
                    const map = { 'ü•∑':1,'ü§ñ':2,'ü¶∏':3,'üßô':4,'ü¶π':5,'üëæ':6 };
                    const nth = map[player2Character];
                    if (nth){
                        const opt = document.querySelector(`#p2-characters .character-option:nth-child(${nth})`);
                        if (opt){
                            document.querySelectorAll('#p2-characters .character-option').forEach(o=>o.classList.remove('selected'));
                            opt.classList.add('selected');
                        }
                    }
                    setOnlineStatus('Guest ready ‚úÖ. You can start the battle!');
                    updateSelectionStatus();
                } else {
                    // host info becomes Player 1
                    player1Name = (msg.name || 'HOST').slice(0,8) || 'HOST';
                    player1Character = msg.char || player1Character || 'ü•∑';
                    if ($('p1-name-input')){
                        $('p1-name-input').value = player1Name;
                    }
                    setOnlineStatus('Synced with host ‚úÖ. Waiting for host to start...');
                    updateSelectionStatus();
                }
                return;
            }

            // Host -> guest: start battle
            if (msg.t === 'start'){
                if (isHost) return;
                try{
                    const st = msg.state;
                    applyHostState(st, true);
                    // show game screen like startBattle does
                    $('display-p1-name').textContent = player1Name;
                    $('display-p2-name').textContent = player2Name;
                    $('char1').textContent = player1Character || 'ü•∑';
                    $('char2').textContent = player2Character || 'ü§ñ';
                    $('character-select').classList.add('hidden');
                    $('game-container').classList.remove('hidden');

                    // Guest is Player 2 controller
                    const p1In = $('input1'); if (p1In) p1In.disabled = true;
                    const p1Btn = document.querySelector('.player1-section .submit-btn'); if (p1Btn) p1Btn.disabled = true;

                    const p2In = $('input2'); if (p2In) p2In.disabled = false;
                    const p2Btn = document.querySelector('.player2-section .submit-btn'); if (p2Btn) p2Btn.disabled = false;

                    gameActive = true;
                    paused = false;
                    safeClearTimer();
                    timerInterval = setInterval(updateTimer, 1000);
                    setOnlineStatus('Battle started! You are Player 2.');
                }catch(_){}
                return;
            }

            // Guest -> host: guess
            if (msg.t === 'guess'){
                if (!isHost) return;
                const letter = (msg.letter || '').toString().toUpperCase().slice(0,1);
                if (!letter) return;
                // Feed into Player 2 and validate using existing logic
                const input = $('input2');
                if (input) input.value = letter;
                checkAnswer(2, true);
                if (onlineMode && isHost) broadcastState();
                return;
            }

            // Host -> guest: state sync
            if (msg.t === 'state'){
                if (isHost) return;
                applyHostState(msg.state, false);
                return;
            }

            // Host -> guest: go home / reset
            if (msg.t === 'home'){
                if (isHost) return;
                goHome();
                setOnlineStatus('Host returned to home.');
                return;
            }
        }

        function exportHostState(){
            return {
                selectedCategory,
                currentLevel,
                timeLeft,
                player1Name,
                player2Name,
                player1Character,
                player2Character,
                player1Score,
                player2Score,
                player1TotalScore,
                player2TotalScore,
                char1Position,
                char2Position,
                player1CurrentWord,
                player2CurrentWord,
                gameActive,
                paused,
                // screens
                levelCompleteVisible: $('level-complete')?.style.display === 'block',
                winnerVisible: $('winner-celebration')?.style.display === 'block',
                levelWinnerText: $('level-winner')?.textContent || '',
                levelStatsText: $('level-stats')?.textContent || ''
            };
        }

        function applyHostState(st, isStart){
            if (!st) return;

            // Basic vars
            selectedCategory = st.selectedCategory || selectedCategory;
            currentLevel = st.currentLevel || currentLevel;
            timeLeft = typeof st.timeLeft === 'number' ? st.timeLeft : timeLeft;

            player1Name = st.player1Name || player1Name;
            player2Name = st.player2Name || player2Name;
            player1Character = st.player1Character || player1Character;
            player2Character = st.player2Character || player2Character;

            player1Score = st.player1Score ?? player1Score;
            player2Score = st.player2Score ?? player2Score;
            player1TotalScore = st.player1TotalScore ?? player1TotalScore;
            player2TotalScore = st.player2TotalScore ?? player2TotalScore;

            char1Position = st.char1Position ?? char1Position;
            char2Position = st.char2Position ?? char2Position;

            player1CurrentWord = st.player1CurrentWord || player1CurrentWord;
            player2CurrentWord = st.player2CurrentWord || player2CurrentWord;

            gameActive = !!st.gameActive;
            paused = !!st.paused;

            // UI updates
            updateLevelDisplay();
            $('timer').textContent = timeLeft;
            updateScores();
            updateCharacters();
            setWordDisplay(1);
            setWordDisplay(2);

            // Level complete / winner screens (host drives)
            if (!isStart){
                if (st.levelCompleteVisible){
                    $('game-area').classList.add('hidden');
                    $('level-complete').style.display = 'block';
                    $('level-winner').textContent = st.levelWinnerText || $('level-winner').textContent;
                    $('level-stats').textContent = st.levelStatsText || $('level-stats').textContent;
                } else {
                    if ($('level-complete').style.display === 'block') $('level-complete').style.display = 'none';
                    if (gameActive) $('game-area').classList.remove('hidden');
                }
                if (st.winnerVisible){
                    $('level-complete').style.display = 'none';
                    $('winner-celebration').style.display = 'block';
                }
            }
        }

        function connectOnline(){
            if (!onlineRoom) { setOnlineStatus('Enter / create a room code.'); return; }

            cleanupOnline();

            isHost = (onlineRole === 'host');

            // Lock the appropriate selection panel
            const p1Section = document.querySelector('.player-select-section.p1');
            const p2Section = document.querySelector('.player-select-section.p2');

            if (isHost){
                // host controls Player 1, guest controls Player 2
                if (p2Section) p2Section.classList.add('cpu-locked');
                if ($('p2-name-input')) $('p2-name-input').disabled = true;
            } else {
                if (p1Section) p1Section.classList.add('cpu-locked');
                if ($('p1-name-input')) $('p1-name-input').disabled = true;
            }

            setOnlineStatus('Connecting...');
            try{
                sigWS = new WebSocket(SIGNALING_URL);
            }catch(e){
                setOnlineStatus('Signaling URL not set / blocked.');
                return;
            }

            sigWS.onopen = async () => {
                setOnlineStatus('Connected to lobby server. Establishing peer...');
                await startPeer();
                sendSig({ t:'join', room: onlineRoom, from: clientId, role: isHost ? 'host' : 'join' });
            };

            sigWS.onmessage = async (ev) => {
                let m=null;
                try{ m = JSON.parse(ev.data); }catch(_){ return; }
                if (!m || m.room !== onlineRoom || m.from === clientId) return;

                // Remember the other side
                if (!remoteId && m.from) remoteId = m.from;

                if (m.t === 'offer' && !isHost){
                    await pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
                    const ans = await pc.createAnswer();
                    await pc.setLocalDescription(ans);
                    sendSig({ t:'answer', room: onlineRoom, from: clientId, to: remoteId, sdp: pc.localDescription });
                } else if (m.t === 'answer' && isHost){
                    try{ if (offerResendTimer) { clearInterval(offerResendTimer); offerResendTimer = null; } }catch(_){ }
                    await pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
                } else if (m.t === 'ice'){
                    try{ await pc.addIceCandidate(m.cand); }catch(_){}
                }
            };

            sigWS.onclose = () => {
                if (!onlineConnected) setOnlineStatus('Lobby server disconnected.');
            };
            sigWS.onerror = () => setOnlineStatus('Lobby server error.');
        }

        async function startPeer(){
            pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            pc.onicecandidate = (e) => {
                if (e.candidate){
                    sendSig({ t:'ice', room: onlineRoom, from: clientId, to: remoteId, cand: e.candidate });
                }
            };

            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected' || pc.connectionState === 'closed'){
                    cleanupOnline();
                }
            };

            if (isHost){
                bindDataChannel(pc.createDataChannel('wba'));
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // Offer will be broadcast to room; guest will answer.
                // Some signaling relays don't forward the initial "join" message, so the host may send
                // the offer before the guest is listening. To make this robust, we resend the offer
                // briefly until we receive an answer / connect.
                sendSig({ t:'offer', room: onlineRoom, from: clientId, sdp: pc.localDescription });

                try{
                    if (offerResendTimer) clearInterval(offerResendTimer);
                    offerResendTimer = setInterval(() => {
                        // Stop resending once connected (or once an answer is applied)
                        if (onlineConnected || !pc || pc.signalingState === 'stable') {
                            clearInterval(offerResendTimer);
                            offerResendTimer = null;
                            return;
                        }
                        // Re-send the latest localDescription as offer (room broadcast)
                        if (pc.localDescription) {
                            sendSig({ t:'offer', room: onlineRoom, from: clientId, sdp: pc.localDescription });
                        }
                    }, 900);
                }catch(_){}

                setOnlineStatus('Room created. Share code with your friend: ' + onlineRoom);
            } else {
                pc.ondatachannel = (e) => bindDataChannel(e.channel);
                setOnlineStatus('Joining room...');
            }
        }
        function applyLockForRole(){
            const p1Section = document.querySelector('.player-select-section.p1');
            const p2Section = document.querySelector('.player-select-section.p2');

            // Clear locks
            if (p1Section) p1Section.classList.remove('cpu-locked');
            if (p2Section) p2Section.classList.remove('cpu-locked');
            if ($('p1-name-input')) $('p1-name-input').disabled = false;
            if ($('p2-name-input')) $('p2-name-input').disabled = false;

            if (!onlineMode) return;

            if (isHost){
                if (p2Section) p2Section.classList.add('cpu-locked');
                if ($('p2-name-input')) $('p2-name-input').disabled = true;
            } else {
                if (p1Section) p1Section.classList.add('cpu-locked');
                if ($('p1-name-input')) $('p1-name-input').disabled = true;
            }
        }

        function connectMatchmake(){
            // Matchmaking: auto-find opponent without typing a room code
            cleanupOnline();
            setOnlineStatus('Connecting for matchmaking...');

            try{
                sigWS = new WebSocket(SIGNALING_URL);
            }catch(e){
                setOnlineStatus('Signaling URL not set / blocked.');
                return;
            }

            sigWS.onopen = () => {
                setOnlineStatus('Finding an opponent...');
                try{ sigWS.send(JSON.stringify({ t:'mm_find' })); }catch(_){}
            };

            sigWS.onmessage = async (ev) => {
                let m=null;
                try{ m = JSON.parse(ev.data); }catch(_){ return; }
                if (!m) return;

                // --- Matchmaking messages do NOT require a room yet ---
                if (m.t === 'mm_wait'){
                    setOnlineStatus('Waiting for an opponent...');
                    return;
                }
                if (m.t === 'mm_match'){
                    onlineRoom = String(m.room || '').toUpperCase();
                    isHost = (m.role === 'host');
                    onlineRole = isHost ? 'host' : 'join';
                    applyLockForRole();

                    setOnlineStatus('Match found! Establishing peer...');
                    await startPeer();
                    sendSig({ t:'join', room: onlineRoom, from: clientId, role: onlineRole });
                    return;
                }

                // After a match is assigned, we handle normal WebRTC signaling
                if (!onlineRoom || m.room !== onlineRoom || m.from === clientId) return;

                if (!remoteId && m.from) remoteId = m.from;

                if (m.t === 'offer' && !isHost){
                    await pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
                    const ans = await pc.createAnswer();
                    await pc.setLocalDescription(ans);
                    sendSig({ t:'answer', room: onlineRoom, from: clientId, to: remoteId, sdp: pc.localDescription });
                } else if (m.t === 'answer' && isHost){
                    try{ if (offerResendTimer) { clearInterval(offerResendTimer); offerResendTimer = null; } }catch(_){ }
                    await pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
                } else if (m.t === 'ice'){
                    try{ await pc.addIceCandidate(m.cand); }catch(_){}
                }
            };

            sigWS.onclose = () => {
                cleanupOnline();
                setOnlineStatus('Disconnected.');
            };

            sigWS.onerror = () => {
                setOnlineStatus('Connection error. Check your SIGNALING_URL / hosting.');
            };
        }


        function startOnlineBattleAsHost(){
            if (!onlineMode || !isHost) return false;
            if (!onlineConnected) { setOnlineStatus('Not connected yet.'); return false; }
            if (!player1Character) { setOnlineStatus('Pick your champion.'); return false; }

            // Ensure host name/char
            player1Name = $('p1-name-input').value.trim().toUpperCase() || 'HERO';
            player2Name = ($('p2-name-input').value.trim().toUpperCase() || 'GUEST');

            $('display-p1-name').textContent = player1Name;
            $('display-p2-name').textContent = player2Name;
            $('char1').textContent = player1Character || 'ü•∑';
            $('char2').textContent = player2Character || 'ü§ñ';

            $('character-select').classList.add('hidden');
            $('game-container').classList.remove('hidden');

            // Host controls Player 1; disable local Player 2 inputs
            const p2In = $('input2'); if (p2In) p2In.disabled = true;
            const p2Btn = document.querySelector('.player2-section .submit-btn'); if (p2Btn) p2Btn.disabled = true;

            // Reset totals and start local game
            player1TotalScore = 0;
            player2TotalScore = 0;

            startGame();

            // Send initial state to guest (guest will start timer and render)
            sendDC({ t:'start', state: exportHostState() });
            return true;
        }

        function broadcastState(){
            if (!onlineMode || !isHost || !onlineConnected) return;
            sendDC({ t:'state', state: exportHostState() });
        }

        function wireUI() {
            const homeBtn = $('home-btn');
            const resetBtn = $('reset-btn');
            if (homeBtn) homeBtn.addEventListener('click', goHome);
            if (resetBtn) resetBtn.addEventListener('click', resetBattle);

            const pauseBtn = $('pause-btn');
            const resumeBtn = $('resume-btn');
            const pauseHomeBtn = $('pause-home-btn');
            if (pauseBtn) pauseBtn.addEventListener('click', togglePause);
            if (resumeBtn) resumeBtn.addEventListener('click', () => setPaused(false));
            if (pauseHomeBtn) pauseHomeBtn.addEventListener('click', () => { setPaused(false); goHome(); });


            const musicToggle = $('music-toggle');
            const musicTrack = $('music-track');
            const sfxToggle = $('sfx-toggle');
            const packSelect = $('sfx-pack');
            const vol = $('master-volume');

            if (musicToggle) musicToggle.addEventListener('change', (e) => { AudioSys.setMusic(e.target.checked); saveAudioPrefs(); });
            if (musicTrack) musicTrack.addEventListener('change', (e) => { AudioSys.setTrack(e.target.value); saveAudioPrefs(); });
            if (sfxToggle) sfxToggle.addEventListener('change', (e) => { AudioSys.setSfx(e.target.checked); saveAudioPrefs(); });
            if (packSelect) packSelect.addEventListener('change', (e) => { AudioSys.setPack(e.target.value); saveAudioPrefs(); });
            if (vol) vol.addEventListener('input', (e) => { AudioSys.setMasterVolume(parseInt(e.target.value, 10) / 100); saveAudioPrefs(true); });

            // Initialize audio from saved prefs or defaults
            loadAudioPrefs();
            saveAudioPrefs();

            // CPU mode controls
            const cpuToggle = $('cpu-toggle');
            const cpuDiff = $('cpu-difficulty');

            function applyCpuModeUI(){
                vsCPU = cpuToggle ? cpuToggle.checked : false;
                cpuDifficulty = cpuDiff ? cpuDiff.value : 'normal';

                // If CPU mode, clear manual selection requirements for player2
                updateSelectionStatus();
            }

            if (cpuToggle) cpuToggle.addEventListener('change', () => { AudioSys.play('click'); applyCpuModeUI(); });
            if (cpuDiff) cpuDiff.addEventListener('change', () => { AudioSys.play('click'); applyCpuModeUI(); });

            applyCpuModeUI();

            // Online mode controls
            const onlineToggle = $('online-toggle');
            const onlinePanel = $('online-panel');
            const roomCode = $('room-code');
            const createBtn = $('create-room-btn');
            const joinBtn = $('join-room-btn');
            const matchBtn = $('matchmake-btn');
            const roleSel = $('role-select');

            if (roleSel) roleSel.addEventListener('change', (e) => { onlineRole = e.target.value; saveAudioPrefs(true); });

            function syncOnlineLocks(){
                const p1Section = document.querySelector('.player-select-section.p1');
                const p2Section = document.querySelector('.player-select-section.p2');

                // Clear locks first
                if (p1Section) p1Section.classList.remove('cpu-locked');
                if (p2Section) p2Section.classList.remove('cpu-locked');
                if ($('p1-name-input')) $('p1-name-input').disabled = false;
                if ($('p2-name-input')) $('p2-name-input').disabled = false;

                if (!onlineMode) return;

                // Online overrides CPU
                vsCPU = false;
                if ($('cpu-toggle')) $('cpu-toggle').checked = false;

                if (onlineRole === 'host'){
                    if (p2Section) p2Section.classList.add('cpu-locked');
                    if ($('p2-name-input')) $('p2-name-input').disabled = true;
                } else {
                    if (p1Section) p1Section.classList.add('cpu-locked');
                    if ($('p1-name-input')) $('p1-name-input').disabled = true;
                }
            }

            if (onlineToggle) onlineToggle.addEventListener('change', (e) => {
                onlineMode = !!e.target.checked;
                if (onlinePanel) onlinePanel.classList.toggle('hidden', !onlineMode);
                if (!onlineMode) {
                    cleanupOnline();
                    setOnlineStatus('Online is off.');
                } else {
                    setOnlineStatus('Choose Host/Join, then Create/Join.');
                }
                syncOnlineLocks();
                updateSelectionStatus();
            });

            if (createBtn) createBtn.addEventListener('click', () => {
                if (!onlineMode) return;
                AudioSys.play('click');
                onlineRole = 'host';
                if (roleSel) roleSel.value = 'host';
                onlineRoom = genRoomCode();
                if (roomCode) roomCode.value = onlineRoom;
                connectOnline();
            });

            if (matchBtn) matchBtn.addEventListener('click', () => {
                if (!onlineMode) return;
                AudioSys.play('click');
                connectMatchmake();
            });

            if (joinBtn) joinBtn.addEventListener('click', () => {
                if (!onlineMode) return;
                AudioSys.play('click');
                onlineRole = 'join';
                if (roleSel) roleSel.value = 'join';
                onlineRoom = (roomCode ? roomCode.value : '').trim().toUpperCase();
                if (!onlineRoom) { setOnlineStatus('Enter a room code first.'); return; }
                connectOnline();
            });
        }
        wireUI();

        // Expose functions used by inline HTML handlers
        window.selectCharacter = selectCharacter;
        window.selectCategory = selectCategory;
        window.startBattle = startBattle;
        window.checkAnswer = checkAnswer;
        window.nextLevel = nextLevel;
        window.resetGame = resetGame;

        // Initial
        updateLevelDisplay();
        updateSelectionStatus();
    </script>

</body>
</html>
